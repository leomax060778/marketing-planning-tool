CREATE COLUMN TABLE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_ORIGIN" (
        "BUDGET_SPEND_REQUEST_ORIGIN_ID" bigint not null primary key generated by default as IDENTITY,
        "NAME" NVARCHAR(255) NOT NULL ,
        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,
        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);

INSERT INTO BUDGET_SPEND_REQUEST_ORIGIN (BUDGET_SPEND_REQUEST_ORIGIN_ID,NAME,CREATED_USER_ID) VALUES (1,'Budget Requester',1);
INSERT INTO BUDGET_SPEND_REQUEST_ORIGIN (BUDGET_SPEND_REQUEST_ORIGIN_ID,NAME,CREATED_USER_ID) VALUES (2,'Budget Approver',1);


CREATE COLUMN TABLE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_STATUS" (
    "BUDGET_SPEND_REQUEST_STATUS_ID" bigint not null primary key generated by default as IDENTITY,
    "NAME" NVARCHAR(50) NOT NULL,
    "DISPLAY_NAME" NVARCHAR(50) NOT NULL,
    "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
    "MODIFIED_DATE_TZ" timestamp,
    "CREATED_USER_ID" bigint not null,
    "MODIFIED_USER_ID" bigint,
    "ENABLED" tinyint default 1,
    "DELETED" tinyint default 0,
    FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);
INSERT INTO "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_STATUS"(BUDGET_SPEND_REQUEST_STATUS_ID, NAME, DISPLAY_NAME, CREATED_USER_ID)VALUES(1, 'Pending', 'Pending', 1);
INSERT INTO "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_STATUS"(BUDGET_SPEND_REQUEST_STATUS_ID, NAME, DISPLAY_NAME, CREATED_USER_ID)VALUES(2, 'Approved', 'Approved', 1);
INSERT INTO "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_STATUS"(BUDGET_SPEND_REQUEST_STATUS_ID, NAME, DISPLAY_NAME, CREATED_USER_ID)VALUES(3, 'NoLongerRequested', 'No Longer Requested', 1);
INSERT INTO "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_STATUS"(BUDGET_SPEND_REQUEST_STATUS_ID, NAME, DISPLAY_NAME, CREATED_USER_ID)VALUES(4, 'Rejected', 'Rejected', 1);

CREATE COLUMN TABLE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST" (
        "BUDGET_SPEND_REQUEST_ID" bigint not null primary key generated by default as IDENTITY,
        "HL_ID" bigint NOT NULL,
        "HIERARCHY_LEVEL_ID" bigint NOT NULL,
        "DESCRIPTION" NVARCHAR(255) NOT NULL,
        "AMOUNT" DECIMAL(19,6) NOT NULL,
        "BUDGET_SPEND_REQUEST_STATUS_ID" bigint NOT NULL,
        "BUDGET_SPEND_REQUEST_TYPE_ID" bigint NOT NULL,
        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,
        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID"),
        FOREIGN KEY ("BUDGET_SPEND_REQUEST_STATUS_ID") REFERENCES "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_STATUS"("BUDGET_SPEND_REQUEST_STATUS_ID"),
        FOREIGN KEY ("BUDGET_SPEND_REQUEST_TYPE_ID") REFERENCES "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_TYPE"("BUDGET_SPEND_REQUEST_TYPE_ID")
);

CREATE COLUMN TABLE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_TYPE" (
        "BUDGET_SPEND_REQUEST_TYPE_ID" bigint not null primary key generated by default as IDENTITY,
        "NAME" NVARCHAR(255) NOT NULL ,
        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,
        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);

INSERT INTO BUDGET_SPEND_REQUEST_TYPE (BUDGET_SPEND_REQUEST_TYPE_ID,NAME,CREATED_USER_ID) VALUES (1,'own_money',1);
INSERT INTO BUDGET_SPEND_REQUEST_TYPE (BUDGET_SPEND_REQUEST_TYPE_ID,NAME,CREATED_USER_ID) VALUES (2,'co_funding_external',1);
INSERT INTO BUDGET_SPEND_REQUEST_TYPE (BUDGET_SPEND_REQUEST_TYPE_ID,NAME,CREATED_USER_ID) VALUES (3,'co_funding_internal',1);

CREATE COLUMN TABLE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_MESSAGE" (
        "BUDGET_SPEND_REQUEST_MESSAGE_ID" bigint not null primary key generated by default as IDENTITY,
        "BUDGET_SPEND_REQUEST_ID" BIGINT NOT NULL,
        "BUDGET_SPEND_REQUEST_ORIGIN_ID" BIGINT NOT NULL,
        "MESSAGE" NVARCHAR(3000) NOT NULL,
        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,
        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);

CREATE COLUMN TABLE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_LOG_STATUS" (
        "BUDGET_SPEND_REQUEST_LOG_STATUS_ID" bigint not null primary key generated by default as IDENTITY,
        "BUDGET_SPEND_REQUEST_ID" bigint NOT NULL,
        "BUDGET_SPEND_REQUEST_STATUS_ID" bigint NOT NULL,
        "REQUESTER_USER_ID" bigint NOT NULL,
        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,
        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID"),
        FOREIGN KEY ("BUDGET_SPEND_REQUEST_STATUS_ID") REFERENCES "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_STATUS"("BUDGET_SPEND_REQUEST_STATUS_ID"),
        FOREIGN KEY ("BUDGET_SPEND_REQUEST_ID") REFERENCES "PLANNING_TOOL"."BUDGET_SPEND_REQUEST"("BUDGET_SPEND_REQUEST_ID"),
        FOREIGN KEY ("REQUESTER_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);

CREATE COLUMN TABLE "PLANNING_TOOL"."HL5_SALE_BUDGET_SPEND_REQUEST" (
        "HL5_SALE_BUDGET_SPEND_REQUEST_ID" bigint not null primary key generated by default as IDENTITY,
        "HL5_SALES_ID" bigint NOT NULL,
        "BUDGET_SPEND_REQUEST_ID" bigint NOT NULL,
        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,
        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID"),
        FOREIGN KEY ("BUDGET_SPEND_REQUEST_ID") REFERENCES "PLANNING_TOOL"."BUDGET_SPEND_REQUEST"("BUDGET_SPEND_REQUEST_ID"),
        FOREIGN KEY ("HL5_SALES_ID") REFERENCES "PLANNING_TOOL"."HL5_SALES"("HL5_SALES_ID")
);

INSERT INTO "PLANNING_TOOL"."PARTNER_TYPE"(PARTNER_TYPE_ID, TYPE_NAME, CREATED_USER_ID) values(3, 'Intel', 1);
UPDATE "PLANNING_TOOL"."PARTNER_TYPE" SET TYPE_NAME = 'External Partner', MODIFIED_DATE_TZ = CURRENT_TIMESTAMP, MODIFIED_USER_ID = 1 WHERE TYPE_NAME = 'Partner Budget';

CREATE COLUMN TABLE "PLANNING_TOOL"."BUDGET_SPEND_APPROVER" (
    "BUDGET_SPEND_APPROVER_ID" bigint not null primary key generated by default as IDENTITY,
    "USER_ID" BIGINT,
    "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
    "MODIFIED_DATE_TZ" timestamp,
    "CREATED_USER_ID" bigint not null,
    "MODIFIED_USER_ID" bigint,
    "ENABLED" tinyint default 1,
    "DELETED" tinyint default 0,
    FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID"),
    FOREIGN KEY ("USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);

CREATE COLUMN TABLE "PLANNING_TOOL"."HL2_BUDGET_SPEND_APPROVER" (
    "HL2_BUDGET_SPEND_APPROVER_ID" bigint not null primary key generated by default as IDENTITY,
    "USER_ID" BIGINT,
    "HL2_ID" bigint,
    "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
    "MODIFIED_DATE_TZ" timestamp,
    "CREATED_USER_ID" bigint not null,
    "MODIFIED_USER_ID" bigint,
    "ENABLED" tinyint default 1,
    "DELETED" tinyint default 0,
    FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID"),
    FOREIGN KEY ("HL2_ID") REFERENCES "PLANNING_TOOL"."HL2"("HL2_ID"),
    FOREIGN KEY ("USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);

ALTER TABLE "PLANNING_TOOL"."HL5_PARTNER" ADD ("INTEL_PROJECT_ID" NVARCHAR(255) NULL, "CLAIM_ID" NVARCHAR(255) NULL, "COMMENTS" NVARCHAR(3000) NULL, "COMPANY_NAME" NVARCHAR(255) NULL, "COMPANY_ADDRESS" NVARCHAR(255) NULL, "INVOICE_NUMBER" NVARCHAR(255) NULL, "BUDGET_SPEND_REQUEST_ID" bigint  NULL);
ALTER TABLE "PLANNING_TOOL"."HL5_PARTNER" ALTER ("VALUE" DECIMAL(19,6) NULL);
ALTER TABLE "PLANNING_TOOL"."HL5_PARTNER" ALTER ("REGION_ID" BIGINT NULL);
ALTER TABLE "PLANNING_TOOL"."HL5_PARTNER" ADD ("CURRENCY_ID" BIGINT NULL);
ALTER TABLE "PLANNING_TOOL"."HL5_PARTNER" ALTER ("PARTNER_NAME" NVARCHAR(512) NULL);
-- Set the current currency according to the father's currency
UPDATE T1
SET
T1.CURRENCY_ID = T2.EURO_CONVERSION_ID
FROM HL5_PARTNER T1
INNER JOIN
(SELECT HL5PARTNER.PARTNER_ID, HL5.EURO_CONVERSION_ID
FROM HL5_PARTNER HL5PARTNER
INNER JOIN HL5 ON HL5.HL5_ID = HL5PARTNER.HL5_ID) T2 ON T1.PARTNER_ID = T2.PARTNER_ID;
-- Set currency to not null
ALTER TABLE "PLANNING_TOOL"."HL5_PARTNER" ALTER (CURRENCY_ID BIGINT NOT NULL);
ALTER TABLE "PLANNING_TOOL"."HL5_PARTNER" ADD FOREIGN KEY ("CURRENCY_ID") REFERENCES "PLANNING_TOOL"."CURRENCY"("EURO_CONVERSION_ID");


UPDATE PARTNER_TYPE SET enabled = 0, deleted = 1 where TYPE_NAME = 'MDF';

ALTER TABLE "PLANNING_TOOL"."HL5_SALES" ADD ("CURRENCY_ID" BIGINT NULL);
-- Set the current currency according to the father's currency
UPDATE T1
SET
T1.CURRENCY_ID = T2.EURO_CONVERSION_ID
FROM HL5_SALES T1
INNER JOIN
(SELECT HL5SALES.HL5_SALES_ID, HL5.EURO_CONVERSION_ID
FROM HL5_SALES HL5SALES
INNER JOIN HL5 ON HL5.HL5_ID = HL5SALES.HL5_ID) T2 ON T1.HL5_SALES_ID = T2.HL5_SALES_ID;
-- Set currency to not null
ALTER TABLE "PLANNING_TOOL"."HL5_SALES" ALTER (CURRENCY_ID BIGINT NOT NULL);
ALTER TABLE "PLANNING_TOOL"."HL5_SALES" ADD FOREIGN KEY ("CURRENCY_ID") REFERENCES "PLANNING_TOOL"."CURRENCY"("EURO_CONVERSION_ID");

CREATE COLUMN TABLE "PLANNING_TOOL"."ATTACHMENT"(
 "ATTACHMENT_ID" bigint not null primary key generated by default as IDENTITY,
 "ORIGINAL_NAME" NVARCHAR(255) NOT NULL,
 "SAVED_NAME" NVARCHAR(255) NOT NULL,
 "ATTACHMENT_SIZE" BIGINT NOT NULL,
 "ATTACHMENT_TYPE" NVARCHAR(255) NOT NULL,
 "CREATED_USER_ID" BIGINT NOT NULL,
 "MODIFIED_USER_ID" BIGINT,
 "CREATED_DATE_TZ" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
 "MODIFIED_DATE_TZ" TIMESTAMP,
 "ENABLED" TINYINT DEFAULT 1,
 "DELETED" TINYINT DEFAULT 0,
 FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);

CREATE COLUMN TABLE "PLANNING_TOOL"."PARTNER_ATTACHMENT"(
 "PARTNER_ATTACHMENT_ID" bigint not null primary key generated by default as IDENTITY,
 "BUDGET_SPEND_REQUEST_ID" BIGINT NOT NULL,
 "ATTACHMENT_ID" BIGINT NOT NULL,
 "HIERARCHY_LEVEL_ID" BIGINT NOT NULL,
 "CREATED_USER_ID" BIGINT NOT NULL,
 "MODIFIED_USER_ID" BIGINT,
 "CREATED_DATE_TZ" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
 "MODIFIED_DATE_TZ" TIMESTAMP,
 "ENABLED" TINYINT DEFAULT 1,
 "DELETED" TINYINT DEFAULT 0,
 FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID"),
 FOREIGN KEY ("ATTACHMENT_ID") REFERENCES "PLANNING_TOOL"."ATTACHMENT"("ATTACHMENT_ID")
);

--********************LEVEL 2***********************************************************
alter table "PLANNING_TOOL"."HL2" add(ALLOW_AUTOMATIC_BUDGET_APPROVAL tinyint default 0);
-- *************************************************************************************

alter table "PLANNING_TOOL"."HL5" add (co_funded tinyint not null default 0);

UPDATE HL5 set co_funded = 1
where hl5_id in (
    select hl5_id from hl5_sales where enabled = 1 and deleted = 0 and amount != 0 and amount is not null
    union
    select hl5_id from hl5_partner where enabled = 1 and deleted = 0 and value != 0 and value is not null
);

--********************NEW RESOURCE 'Spend Budget Requests'***********************************************************
INSERT INTO "PLANNING_TOOL"."RESOURCE"(name, object_name, created_user_id)
  VALUES('Spend Budget Requests', 'SpendBudgetRequests', 1);

--**** Permissions for SuperAdmin ****
INSERT INTO "PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id)
  VALUES(1, 13, 9, 1);

INSERT INTO "PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id)
  VALUES(1, 13, 10, 1);

INSERT INTO "PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id)
  VALUES(1, 13, 11, 1);
-- *************************************************************************************

--********************NEW RESOURCE 'Budget Sources'***********************************************************
INSERT INTO "PLANNING_TOOL"."RESOURCE"(name, object_name, created_user_id) 
  VALUES('Budget Sources Report', 'BudgetSourcesReport', 1);

--**** Permissions for SuperAdmin ****
INSERT INTO "PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) 
  VALUES(1, 14, 9, 1);
  
INSERT INTO "PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) 
  VALUES(1, 14, 10, 1);
  
INSERT INTO "PLANNING_TOOL"."ROLE_PERMISSION"(role_id, resource_id, permission_id, created_user_id) 
  VALUES(1, 14, 11, 1);
-- *************************************************************************************

--********************Add DISPLAY_NAME into BUDGET_SPEND_REQUEST_TYPE ***********************************************************

--** Add column
ALTER TABLE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_TYPE" ADD(DISPLAY_NAME NVARCHAR(50) NULL);

--** Add data for existent values
UPDATE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_TYPE" BSRT
	SET BSRT.DISPLAY_NAME = 'Own Money'
	WHERE BSRT.NAME = 'own_money';
	
UPDATE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_TYPE" BSRT
	SET BSRT.DISPLAY_NAME = 'External Funding'
	WHERE BSRT.NAME = 'co_funding_external';
	
UPDATE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_TYPE" BSRT
	SET BSRT.DISPLAY_NAME = 'Internal Shared Funding'
	WHERE BSRT.NAME = 'co_funding_internal';
	
--** Update the column DISPLAY_NAME at NOT NULL
ALTER TABLE "PLANNING_TOOL"."BUDGET_SPEND_REQUEST_TYPE" ALTER (DISPLAY_NAME nvarchar(50) NOT NULL);
-- *************************************************************************************

--******** budget spend request for HL6 *****************

CREATE COLUMN TABLE "PLANNING_TOOL"."HL6_SALE_BUDGET_SPEND_REQUEST" (
        "HL6_SALE_BUDGET_SPEND_REQUEST_ID" bigint not null primary key generated by default as IDENTITY,
        "HL6_SALES_ID" bigint NOT NULL,
        "BUDGET_SPEND_REQUEST_ID" bigint NOT NULL,
        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,
        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID"),
        FOREIGN KEY ("BUDGET_SPEND_REQUEST_ID") REFERENCES "PLANNING_TOOL"."BUDGET_SPEND_REQUEST"("BUDGET_SPEND_REQUEST_ID"),
        FOREIGN KEY ("HL6_SALES_ID") REFERENCES "PLANNING_TOOL"."HL6_SALES"("HL6_SALES_ID")
);

ALTER TABLE "PLANNING_TOOL"."HL6_PARTNER" ADD ("INTEL_PROJECT_ID" NVARCHAR(255) NULL, "CLAIM_ID" NVARCHAR(255) NULL, "COMMENTS" NVARCHAR(3000) NULL, "COMPANY_NAME" NVARCHAR(255) NULL, "COMPANY_ADDRESS" NVARCHAR(255) NULL, "INVOICE_NUMBER" NVARCHAR(255) NULL, "BUDGET_SPEND_REQUEST_ID" bigint  NULL);
ALTER TABLE "PLANNING_TOOL"."HL6_PARTNER" ALTER ("VALUE" DECIMAL(19,6) NULL);
ALTER TABLE "PLANNING_TOOL"."HL6_PARTNER" ALTER ("REGION_ID" BIGINT NULL);
ALTER TABLE "PLANNING_TOOL"."HL6_PARTNER" ADD ("CURRENCY_ID" BIGINT NULL);
ALTER TABLE "PLANNING_TOOL"."HL6_PARTNER" ALTER ("PARTNER_NAME" NVARCHAR(512) NULL);
-- Set the current currency according to the father's currency
UPDATE T1
SET
T1.CURRENCY_ID = T2.EURO_CONVERSION_ID
FROM HL6_PARTNER T1
INNER JOIN
(SELECT HL6PARTNER.HL6_PARTNER_ID, HL6.EURO_CONVERSION_ID
FROM HL6_PARTNER HL6PARTNER
INNER JOIN HL6 ON HL6.HL6_ID = HL6PARTNER.HL6_ID) T2 ON T1.HL6_PARTNER_ID = T2.HL6_PARTNER_ID;
-- Set currency to not null
ALTER TABLE "PLANNING_TOOL"."HL6_PARTNER" ALTER (CURRENCY_ID BIGINT NOT NULL);
ALTER TABLE "PLANNING_TOOL"."HL6_PARTNER" ADD FOREIGN KEY ("CURRENCY_ID") REFERENCES "PLANNING_TOOL"."CURRENCY"("EURO_CONVERSION_ID");

UPDATE PARTNER_TYPE SET enabled = 0, deleted = 1 where TYPE_NAME = 'MDF';

ALTER TABLE "PLANNING_TOOL"."HL6_SALES" ADD ("CURRENCY_ID" BIGINT NULL);
-- Set the current currency according to the father's currency
UPDATE T1
SET
T1.CURRENCY_ID = T2.EURO_CONVERSION_ID
FROM HL6_SALES T1
INNER JOIN
(SELECT HL6SALES.HL6_SALES_ID, HL6.EURO_CONVERSION_ID
FROM HL6_SALES HL6SALES
INNER JOIN HL6 ON HL6.HL6_ID = HL6SALES.HL6_ID) T2 ON T1.HL6_SALES_ID = T2.HL6_SALES_ID;
-- Set currency to not null
ALTER TABLE "PLANNING_TOOL"."HL6_SALES" ALTER (CURRENCY_ID BIGINT NOT NULL);
ALTER TABLE "PLANNING_TOOL"."HL6_SALES" ADD FOREIGN KEY ("CURRENCY_ID") REFERENCES "PLANNING_TOOL"."CURRENCY"("EURO_CONVERSION_ID");

alter table "PLANNING_TOOL"."HL6" add (co_funded tinyint not null default 0);

UPDATE HL6 set co_funded = 1
where hl6_id in (
        select hl6_id from hl6_sales where enabled = 1 and deleted = 0 and amount != 0 and amount is not null
union
select hl6_id from hl6_partner where enabled = 1 and deleted = 0 and value != 0 and value is not null
);


ALTER TABLE "PLANNING_TOOL"."HL5" ADD ("ALLOW_BUDGET_ZERO" TINYINT NULL DEFAULT 0);

ALTER TABLE "PLANNING_TOOL"."HL6" ADD ("ALLOW_BUDGET_ZERO" TINYINT NULL DEFAULT 0);
--***************************************************************************************
-- Update schema version
INSERT INTO SCHEMA_VERSION(VERSION, DESCRIPTION, SCRIPT)
VALUES('V5.0.0-45', 'Include changes to Budget Spend request', 'V201706211330__Budget_Spend.sql');

COMMIT;