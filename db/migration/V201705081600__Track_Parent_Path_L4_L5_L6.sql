CREATE COLUMN TABLE "PLANNING_TOOL"."CRM_PARENT_PATH" (
    CRM_PARENT_PATH_ID bigint not null primary key generated by default as IDENTITY,
    HIERARCHY_LEVEL_ID BIGINT NOT NULL,
    LEVEL_ID BIGINT NOT NULL,
    PARENT_PATH NVARCHAR(255) NOT NULL,
    CREATED_DATE_TZ timestamp default CURRENT_TIMESTAMP,
    MODIFIED_DATE_TZ timestamp,
	CREATED_USER_ID bigint not null,
	MODIFIED_USER_ID bigint
);

INSERT INTO CRM_PARENT_PATH (HIERARCHY_LEVEL_ID,LEVEL_ID,PARENT_PATH,CREATED_USER_ID)
(
    (SELECT 1 AS HIERARCHY_LEVEL_ID
    , HL4.HL4_ID AS LEVEL_ID
    ,CONCAT('CRM-',
    CONCAT(
        CONCAT(CONCAT(HL1.ACRONYM, SUBSTRING(TO_NVARCHAR(BGY.BUDGET_YEAR), 3, 2)),'-')
        , HL3.ACRONYM)
         ) AS PARENT_PATH
    , 1 AS CREATED_USER_ID
    FROM HL4
    INNER JOIN HL3 ON  HL3.HL3_ID = HL4.HL3_ID
    INNER JOIN HL2 ON HL2.HL2_ID = HL3.HL2_ID
    INNER JOIN HL1 ON HL1.HL1_ID = HL2.HL1_ID
    INNER JOIN BUDGET_YEAR BGY ON HL1.BUDGET_YEAR_ID = BGY.BUDGET_YEAR_ID
    WHERE HL4.ENABLED = 1 AND HL4.DELETED = 0
    )
    UNION ALL
    (SELECT 2 AS HIERARCHY_LEVEL_ID
    , HL5.HL5_ID AS LEVEL_ID
    ,CONCAT('CRM-',
    CONCAT(
    CONCAT(CONCAT(
        CONCAT(CONCAT(HL1.ACRONYM, SUBSTRING(TO_NVARCHAR(BGY.BUDGET_YEAR), 3, 2)),'-')
        , HL3.ACRONYM),'-')
        ,HL4.ACRONYM)
         ) AS PARENT_PATH
    , 1 AS CREATED_USER_ID
    FROM HL5
    INNER JOIN HL4 ON HL4.HL4_ID = HL5.HL4_ID
    INNER JOIN HL3 ON HL3.HL3_ID = HL4.HL3_ID
    INNER JOIN HL2 ON HL2.HL2_ID = HL3.HL2_ID
    INNER JOIN HL1 ON HL1.HL1_ID = HL2.HL1_ID
    INNER JOIN BUDGET_YEAR BGY ON HL1.BUDGET_YEAR_ID = BGY.BUDGET_YEAR_ID
    WHERE HL5.ENABLED = 1 AND HL5.DELETED = 0
    )
    UNION ALL
    (SELECT 3 AS HIERARCHY_LEVEL_ID
    , HL6.HL6_ID AS LEVEL_ID
    ,CONCAT('CRM-',
    CONCAT(
        CONCAT(
            CONCAT(CONCAT(
                CONCAT(CONCAT(HL1.ACRONYM, SUBSTRING(TO_NVARCHAR(BGY.BUDGET_YEAR), 3, 2)),'-')
                , HL3.ACRONYM),'-')
            ,HL4.ACRONYM)
        , HL5.ACRONYM)
         ) AS PARENT_PATH
    , 1 AS CREATED_USER_ID
    FROM HL6
    INNER JOIN HL5 ON HL5.HL5_ID = HL6.HL5_ID
    INNER JOIN HL4 ON HL4.HL4_ID = HL5.HL4_ID
    INNER JOIN HL3 ON HL3.HL3_ID = HL4.HL3_ID
    INNER JOIN HL2 ON HL2.HL2_ID = HL3.HL2_ID
    INNER JOIN HL1 ON HL1.HL1_ID = HL2.HL1_ID
    INNER JOIN BUDGET_YEAR BGY ON HL1.BUDGET_YEAR_ID = BGY.BUDGET_YEAR_ID
    WHERE HL6.ENABLED = 1 AND HL6.DELETED = 0
    )
);


-- *************************************************************************************
-- Update schema version
INSERT INTO SCHEMA_VERSION(VERSION, DESCRIPTION, SCRIPT)
VALUES('V5.0.0-39', 'Improve tracking for changes on parent path for L4-L6', 'V201705081600__Track_Parent_Path_L4_L5_L6.sql');

COMMIT;