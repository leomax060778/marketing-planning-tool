-- Rename column to reflect the right data
RENAME COLUMN "PLANNING_TOOL".INTERLOCK_REQUEST_MESSAGE.INTERLOCK_CONTACT_DATA_ID TO "INTERLOCK_REQUEST_ID";

-- Alter INTERLOCK_REQUEST_MESSAGE 
ALTER TABLE INTERLOCK_REQUEST_MESSAGE ADD (SENDER_ID BIGINT NULL);
ALTER TABLE INTERLOCK_REQUEST_MESSAGE ADD (INTERLOCK_REQUEST_ORIGIN_ID BIGINT NULL);

-- Create table Interlock Request Origin
CREATE COLUMN TABLE "PLANNING_TOOL"."INTERLOCK_REQUEST_ORIGIN" (
        "INTERLOCK_REQUEST_ORIGIN_ID" bigint not null primary key generated by default as IDENTITY,
        "NAME" NVARCHAR(255) NOT NULL ,

        "CREATED_DATE_TZ" timestamp default CURRENT_TIMESTAMP,
        "MODIFIED_DATE_TZ" timestamp,
        "CREATED_USER_ID" bigint not null,
        "MODIFIED_USER_ID" bigint,
        "ENABLED" tinyint default 1,
        "DELETED" tinyint default 0,

        FOREIGN KEY ("CREATED_USER_ID") REFERENCES "PLANNING_TOOL"."USER"("USER_ID")
);

INSERT INTO INTERLOCK_REQUEST_ORIGIN (INTERLOCK_REQUEST_ORIGIN_ID,NAME,CREATED_USER_ID) VALUES (1,'Requester',1);
INSERT INTO INTERLOCK_REQUEST_ORIGIN (INTERLOCK_REQUEST_ORIGIN_ID,NAME,CREATED_USER_ID) VALUES (2,'Money Lender',1);

-- Update the interlock request origin for Money Lender
UPDATE INTERLOCK_REQUEST_MESSAGE SET SENDER_ID = CREATED_USER_ID, INTERLOCK_REQUEST_ORIGIN_ID = 2;

--CHANGE TYPE MESSAGE COLUMN FROM TEXT TO NVARCHAR(3000)
ALTER TABLE INTERLOCK_REQUEST_MESSAGE ADD ("MESSAGE_NEW" NVARCHAR(3000));

UPDATE INTERLOCK_REQUEST_MESSAGE IMP
SET MESSAGE_NEW = (SELECT CAST(MESSAGE AS NVARCHAR(3000)) FROM INTERLOCK_REQUEST_MESSAGE IM 
WHERE IM.INTERLOCK_REQUEST_MESSAGE_ID = IMP.INTERLOCK_REQUEST_MESSAGE_ID);

ALTER TABLE INTERLOCK_REQUEST_MESSAGE DROP ("MESSAGE");

RENAME COLUMN "INTERLOCK_REQUEST_MESSAGE"."MESSAGE_NEW" TO "MESSAGE";

-- *************************************************************************************
-- Update schema version
INSERT INTO SCHEMA_VERSION(VERSION, DESCRIPTION, SCRIPT) 
VALUES('V5.0.0-04', 'Renamed column in interlock request message', 'V201611231445__Rename_Interlock_message.sql');

COMMIT;



